WITH 
	/* QTD */
	member z_qtd as sum(
		qtd( [Date Commissioned].[Calendar Time].CurrentMember) ,[Measures].[Quota TC]) 

	member z_mtd as sum( mtd( [Date Commissioned].[Calendar Time].CurrentMember) ,[Measures].[Quota TC]) 

	member [Measures].[QTD Current Month Quota] as 
	   z_qtd - z_mtd + [MTD Quota TC]

	/* YTD */
	member z_ytd as sum(
		ytd( [Date Commissioned].[Calendar Time].CurrentMember) ,[Measures].[Quota TC]) 

	member [Measures].[YTD Current Month Quota] as 
	   z_ytd - z_mtd + [MTD Quota TC]

	//Actually pulling ToDate PTQ's not Full PTQ's
	/*member [Measures].[Full Month PTQ] as
		([Measures].[Sales MTD] / [MTD Quota TC])
		
	member [Measures].[Full Quarter PTQ] as
		([Measures].[Sales QTD] / [Measures].[QTD Current Month Quota])	
		
	member [Measures].[Full Year PTQ] as
		([Measures].[Sales YTD] / [Measures].[YTD Current Month Quota])	
		*/


	//Actually pulling ToDate PTQ's not Full PTQ's
	member [Measures].[Full Month PTQ] as
		iif(isempty([MTD Quota TC]),0, ([Measures].[Sales MTD] / [MTD Quota TC]))	
		
		
	member [Measures].[Full Quarter PTQ] as
		iif(isempty([Measures].[QTD Current Month Quota]),0, ([Measures].[Sales QTD] / [Measures].[QTD Current Month Quota]))	
		//([Measures].[Sales QTD] / [Measures].[QTD Current Month Quota])	
		
	member [Measures].[Full Year PTQ] as
		iif(isempty([Measures].[YTD Current Month Quota]),0, ([Measures].[Sales YTD] / [Measures].[YTD Current Month Quota]))	
		//([Measures].[Sales YTD] / [Measures].[YTD Current Month Quota])	


	MEMBER [Measures].[Geog ID] as
		[Sales Geography].[Sales Geography].CurrentMember.Properties("Key")		
		
	MEMBER [Measures].[Parent Name] as
		[Sales Geography].[Sales Geography].CurrentMember.Parent.Name	

	//National Sales Rankings			
     MEMBER [Measures].[Natl Sales Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Sales MTD])		
			
     MEMBER [Measures].[Natl Sales Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Sales QTD])		
			
     MEMBER [Measures].[Natl Sales Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Sales YTD])							
		
	//National PTQ Rankings		
     MEMBER [Measures].[Natl PTQ Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Full Month PTQ])								
			
     MEMBER [Measures].[Natl PTQ Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Full Quarter PTQ])						
			
     MEMBER [Measures].[Natl PTQ Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			[Measures].[Full Year PTQ])		
	
	//MTD Rankings
     MEMBER [Measures].[PTQ Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Full Month PTQ])
			
     MEMBER [Measures].[Sales Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Measures].[Sales MTD])	
		
	//QTD Rankings	
     MEMBER [Measures].[PTQ Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Full Quarter PTQ])		
			
     MEMBER [Measures].[Sales Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Measures].[Sales QTD])	

	//YTD Rankings
     MEMBER [Measures].[PTQ Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Full Year PTQ])		
			
     MEMBER [Measures].[Sales Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
			STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			[Measures].[Sales YTD]
		)					 
 
	//Sales with Open Orders
	member [Measures].[Sales YTD]  as
	(
		[Measures].[YTD Commissioned Sales USD] + [Measures].[Comm Net Open Order USD QTR] - [Measures].[Prior Year Last Month ME OO]
	)	 
	
    member [Measures].[Comm Net Open Order USD QTR] as
            ([Date Commissioned].[Calendar Time].CurrentMember.Parent, [Measures].[Commissioned Open Orders USD])    	
            
	member [Measures].[Prior Quarter Last Month ME OO] as
		(
			PARALLELPERIOD([Date Commissioned].[Calendar Time].[Quarter],1, [Date Commissioned].[Calendar Time].CurrentMember.Parent.Parent.LastChild)
			, [Measures].[Commissioned Open Orders USD], [Commissionable Flag].[Commissionable].&[Yes]
		)	
		
	member [Measures].[Prior Year Last Month ME OO] as
		(
			PARALLELPERIOD([Date Commissioned].[Calendar Time].[Year],1, [Date Commissioned].[Calendar Time].CurrentMember.Parent.Parent.Parent.LastChild)
			, [Measures].[Commissioned Open Orders USD], [Commissionable Flag].[Commissionable].&[Yes]
		)	            			

	member [Measures].[Sales QTD]  as
		[Measures].[QTD Commissioned Sales USD] + [Measures].[Comm Net Open Order USD QTR] - [Measures].[Prior Quarter Last Month ME OO]			
			

	member [Measures].[Sales MTD] as
	 [Measures].[MTD Direct Sales USD] + [Measures].[MTD Trace Sales USD] + [Measures].[Open Order Line Amount USD] + [Measures].[Prior Month Open USD]		
	
	
	member [Measures].[Open Order Line Amount USD] as
	   ( 
		( 
		[Date Commissioned].[Calendar Time].CurrentMember.Parent, [Measures].[Commissioned Open Orders USD]
			
	   )  , [Commissionable Flag].[Commissionable].&[Yes]		
	   )  	
	
   
   //Open Order Cals
	/*member [Measures].[Prior Month Open USD] as
			(
				PARALLELPERIOD([Date Commissioned].[Calendar Time].[Month],1, [Date Commissioned].[Calendar Time].CurrentMember.Parent)
				, [Measures].[ME Order Amount], [Commissionable Flag].[Commissionable].&[Yes]
			)	* -1
*/
member [Measures].[Prior Month Open USD] as
		([Date Commissioned].[Calendar Time].CurrentMember.Parent, [Measures].[Commissioned Open Order Reversals USD])					
		
	member [Measures].[Prior Month OO] as
			(
			[Measures].[ME Order Amount], [Commissionable Flag].[Commissionable].&[Yes]
		)	
		
	member [Measures].[Current Month OO] as
		(
			PARALLELPERIOD([Date Commissioned].[Calendar Time].[Quarter],1, [Date Commissioned].[Calendar Time].CurrentMember.Parent)
			, [Measures].[ME Order Amount]
		)		 		
		
	member NetOpen as
		([Measures].[Prior Month OO] - [Measures].[Current Month OO])
	
	member [Measures].[OpenOrderAmt QTD] as
		([Measures].[Order Line Amount TC], [Commissionable Flag].[Commissionable].&[Yes]) + NetOpen
		 
		
	//National Growth Rankings
     MEMBER [Measures].[Natl Growth Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[MTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[MTD Commissioned Sales Growth % USD])
		)	
			
     MEMBER [Measures].[Natl Growth Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[QTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[QTD Commissioned Sales Growth % USD])
		)
			
     MEMBER [Measures].[Natl Growth Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				[Sales Geography].[Sales Geography].CurrentMember.Parent.Parent, Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[YTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[YTD Commissioned Sales Growth % USD])
		)											
				
	//Growth Rankings			
     MEMBER [Measures].[Growth Rank MTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[MTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[MTD Commissioned Sales Growth % USD])
		)
			
     MEMBER [Measures].[Growth Rank QTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[QTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[QTD Commissioned Sales Growth % USD])
		)
			
     MEMBER [Measures].[Growth Rank YTD] AS
     RANK(
		[Sales Geography].[Sales Geography].CurrentMember, 
		DESCENDANTS(
				STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
			), 
			IIF( IsEmpty([Measures].[YTD Commissioned Sales Growth % USD]), -99999999.0, [Measures].[YTD Commissioned Sales Growth % USD])
		)							
		
	//PRIOR YEAR SALES
	MEMBER [Measures].[Sales PYTD] as
		[Measures].[PYTD Commissioned Sales USD]
		
	MEMBER [Measures].[Sales PQTD] as
		[Measures].[PQTD Commissioned Sales USD]		
	
	MEMBER [Measures].[Sales PMTD] as
		[Measures].[PMTD Commissioned Sales USD]
		
	//PRIOR YEAR SALES
	MEMBER [Measures].[Growth % MTD] as
		[Measures].[MTD Commissioned Sales Growth % USD]
		
	MEMBER [Measures].[Growth % QTD] as
		[Measures].[QTD Commissioned Sales Growth % USD]	
	
	MEMBER [Measures].[Growth % YTD] as
		[Measures].[YTD Commissioned Sales Growth % USD]	
		
				
		
	member [Measures].[Prior Year End OO TC] as
		//(([Measures].[Prior Month Open Orders USD], [Commissionable Flag].[Commissionable].&[Yes]) * -1)
		(
			PARALLELPERIOD([Date Commissioned].[Calendar Time].[Year],1, [Date Commissioned].[Calendar Time].CurrentMember.Parent.Parent.Parent)
			, [Measures].[ME Order Amount], [Commissionable Flag].[Commissionable].&[Yes]
		)				
			
SELECT 
 ({ 
	[Measures].[Parent Name],
	[Measures].[Geog ID],

	[Measures].[Sales MTD],
	[Measures].[Sales YTD],	
	[Measures].[Sales QTD],	
	
	[Measures].[Sales PMTD],
	[Measures].[Sales PQTD],
	[Measures].[Sales PYTD],

	[Measures].[Growth % MTD],
	[Measures].[Growth % QTD],
	[Measures].[Growth % YTD],

	[Measures].[Natl Sales Rank MTD],
	[Measures].[Natl Sales Rank QTD],
	[Measures].[Natl Sales Rank YTD],	
	[Measures].[Natl PTQ Rank MTD],
	[Measures].[Natl PTQ Rank QTD],
	[Measures].[Natl PTQ Rank YTD],	
	
	[Measures].[Full Month PTQ],
	[Measures].[Full Quarter PTQ],
	[Measures].[Full Year PTQ],
	[Measures].[PTQ Rank MTD],
	[Measures].[PTQ Rank QTD],
	[Measures].[PTQ Rank YTD],
	[Measures].[Sales Rank MTD],
	[Measures].[Sales Rank QTD],
	[Measures].[Sales Rank YTD],
		
	[Measures].[Growth Rank MTD],
	[Measures].[Growth Rank QTD],
	[Measures].[Growth Rank YTD],
		
	[Measures].[Natl Growth Rank MTD],
	[Measures].[Natl Growth Rank QTD],
	[Measures].[Natl Growth Rank YTD]
  })
ON COLUMNS,
   //NonEmpty(
Order(
	filter(
		DESCENDANTS(
			STRTOMEMBER(@SalesGeoMemberKey), Levels(@ChildMember)
		), 
		[Measures].[YTD Commissioned Sales TC])
	//)
, [Sales Geography].[Sales Geography].CurrentMember.Name)
ON ROWS
FROM [SalesOrders]
WHERE (
STRTOMEMBER(@DateKey)
)